# Изменения для адаптации под классический чекаут WooCommerce

## Основные изменения

### ✅ Исправлено использование поля адреса
- **Проблема**: Плагин создавал отдельное поле для ввода города
- **Решение**: Теперь используется стандартное поле `billing_address_1` из WooCommerce
- **Результат**: Фильтрация пунктов выдачи работает по введенному в адресе городу

### ✅ Добавлены кнопки выбора способа доставки
- **Самовывоз**: г.Саратов, ул. Осипова, д. 18а - Бесплатно
- **Обсудить с менеджером**: Бесплатно
- **Доставка СДЭК**: С расчетом стоимости по API

### ✅ Исправлена проблема серой карты
- **Проблема**: Карта не отображалась из-за множественных `display: none`
- **Решение**: Убраны лишние скрытия элементов, добавлена правильная инициализация
- **Результат**: Карта корректно загружается и отображает пункты выдачи

### ✅ Улучшен автокомплит городов
- Использует стандартное поле адреса WooCommerce
- Сохраняет историю поиска в localStorage
- Показывает индикаторы загрузки
- Автоматически ищет пункты выдачи при вводе города

### ✅ Исправлена валидация
- Обязательный выбор пункта выдачи только для доставки СДЭК
- Для самовывоза и менеджера валидация не требуется
- Корректные сообщения об ошибках

## Новые файлы

1. **`assets/js/cdek-delivery-classic.js`** - Версия для классического чекаута
2. **`README.md`** - Подробная документация по использованию
3. **`CHANGELOG.md`** - Этот файл с описанием изменений

## Обновленные файлы

1. **`cdek-delivery-plugin.php`**:
   - Автоматическая детекция типа чекаута
   - Новые хуки для классического чекаута
   - Шорткод для ручного размещения карты
   - Методы для рендеринга HTML карты
   - CSS стили для классического интерфейса
   - Валидация выбора пункта выдачи

2. **`assets/js/cdek-delivery.js`** - Остался без изменений для блочного редактора

## Как проверить что все работает

### 1. Проверка автодетекции
```javascript
// В консоли браузера должно быть:
console.log(cdek_ajax.is_block_checkout); // false для классического
```

### 2. Проверка загрузки правильного JS файла
- Классический чекаут: загружается `cdek-delivery-classic.js`
- Блочный чекаут: загружается `cdek-delivery.js`

### 3. Проверка работы поиска городов
1. Введите название города в поле "Адрес"
2. Должны появиться подсказки с городами
3. При выборе города автоматически ищутся пункты выдачи

### 4. Проверка кнопок способов доставки
1. Кнопка "Самовывоз" - скрывает карту, показывает "Бесплатно"
2. Кнопка "Обсудить с менеджером" - скрывает карту, показывает "Бесплатно"  
3. Кнопка "Доставка СДЭК" - показывает карту и список пунктов

### 5. Проверка валидации
- При выборе СДЭК без пункта выдачи должна показываться ошибка
- При выборе самовывоза/менеджера валидация не срабатывает

## Устранение неполадок

### Карта не отображается
1. Откройте консоль браузера (F12)
2. Проверьте ошибки JavaScript
3. Убедитесь что API ключ Яндекс.Карт корректный
4. Проверьте что выбран метод доставки СДЭК

### Не работает поиск городов
1. Проверьте что поле `billing_address_1` существует на странице
2. Убедитесь что в консоли нет ошибок JavaScript
3. Проверьте работу AJAX запросов в Network tab

### Не рассчитывается стоимость
1. Проверьте учетные данные СДЭК в настройках
2. Убедитесь что город отправителя указан корректно
3. Проверьте логи WordPress на ошибки API

### Конфликты с темой
1. Используйте шорткод `[cdek_delivery_map]` для ручного размещения
2. Добавьте кастомные CSS стили при необходимости
3. Проверьте что тема не переопределяет стили WooCommerce

## Техническая информация

### Селекторы для классического чекаута
- Поле адреса: `#billing_address_1`
- Методы доставки: `input[name^="shipping_method"]`
- Таблица заказа: `#order_review, .shop_table`
- Стоимость доставки: `.shipping .amount`

### Ключевые функции JavaScript
- `initCdekDelivery()` - Инициализация плагина
- `searchCdekPoints(city)` - Поиск пунктов выдачи
- `selectCdekPoint(point)` - Выбор пункта выдачи
- `updateClassicShippingCost()` - Обновление стоимости

### PHP хуки
- `woocommerce_review_order_after_shipping` - Размещение после методов доставки
- `woocommerce_checkout_after_customer_details` - Альтернативное размещение
- `woocommerce_checkout_process` - Валидация выбора пункта

## Совместимость

✅ **Поддерживается:**
- WordPress 5.0+
- WooCommerce 8.0+
- PHP 7.4+
- Классический чекаут WooCommerce
- Блочный чекаут WooCommerce
- Мобильные устройства

❌ **Не поддерживается:**
- WordPress ниже 5.0
- WooCommerce ниже 8.0  
- PHP ниже 7.4
- Internet Explorer