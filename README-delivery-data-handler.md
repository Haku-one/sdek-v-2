# –°–î–≠–ö –î–æ—Å—Ç–∞–≤–∫–∞ - –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–∞–Ω–Ω—ã—Ö –¥–æ—Å—Ç–∞–≤–∫–∏

## –û–ø–∏—Å–∞–Ω–∏–µ

–§–∞–π–ª `cdek-delivery-data-handler.php` —Å–æ–¥–µ—Ä–∂–∏—Ç –æ—Ç–¥–µ–ª—å–Ω—ã–π –∫–ª–∞—Å—Å `CDEK_Delivery_Data_Handler` –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö –¥–æ—Å—Ç–∞–≤–∫–∏ –°–î–≠–ö. –≠—Ç–æ—Ç –º–æ–¥—É–ª—å –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞ –ø–µ—Ä–µ–¥–∞—á—É –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –¥–æ—Å—Ç–∞–≤–∫–µ –≤ email —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è, —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –∑–∞–∫–∞–∑–µ –∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ –∞–¥–º–∏–Ω–∫–µ.

## –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å

### üìß Email —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –±–ª–æ–∫–∞ —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –¥–æ—Å—Ç–∞–≤–∫–µ –≤–æ –≤—Å–µ email —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ HTML –∏ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∞
- –ö—Ä–∞—Å–∏–≤–æ–µ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ —Å —ç–º–æ–¥–∑–∏ –∏ —Å—Ç–∏–ª—è–º–∏
- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –≤–∫–ª—é—á–∞–µ—Ç:
  - –ù–∞–∑–≤–∞–Ω–∏–µ –ø—É–Ω–∫—Ç–∞ –≤—ã–¥–∞—á–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, "–¢—é–º–µ–Ω—å, –ê–≤—Ç–æ—Ä–µ–º–æ–Ω—Ç–Ω–∞—è")
  - –°—Ç–æ–∏–º–æ—Å—Ç—å –¥–æ—Å—Ç–∞–≤–∫–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, "2190 —Ä—É–±.")
  - –ü–æ–ª–Ω—ã–π –∞–¥—Ä–µ—Å –ø—É–Ω–∫—Ç–∞ –≤—ã–¥–∞—á–∏
  - –ö–æ–¥ –ø—É–Ω–∫—Ç–∞, —Ç–µ–ª–µ—Ñ–æ–Ω –∏ —Ä–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã

### üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –∑–∞–∫–∞–∑–µ
- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö –¥–æ—Å—Ç–∞–≤–∫–∏ –≤ –º–µ—Ç–∞–ø–æ–ª—è—Ö –∑–∞–∫–∞–∑–∞
- –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–ª—è —É–¥–æ–±–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–π
- –°–æ—Ö—Ä–∞–Ω—è–µ–º—ã–µ –¥–∞–Ω–Ω—ã–µ:
  - `_cdek_delivery_cost` - —Å—Ç–æ–∏–º–æ—Å—Ç—å –¥–æ—Å—Ç–∞–≤–∫–∏
  - `_cdek_point_code` - –∫–æ–¥ –ø—É–Ω–∫—Ç–∞ –≤—ã–¥–∞—á–∏
  - `_cdek_point_data` - –ø–æ–ª–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø—É–Ω–∫—Ç–∞
  - `_cdek_point_display_name` - –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ
  - `_cdek_point_address` - –ø–æ–ª–Ω—ã–π –∞–¥—Ä–µ—Å
  - `_cdek_point_phone` - —Ç–µ–ª–µ—Ñ–æ–Ω –ø—É–Ω–∫—Ç–∞
  - `_cdek_point_work_time` - —Ä–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã
  - `_cdek_point_city` - –≥–æ—Ä–æ–¥

### üîß –ê–¥–º–∏–Ω–∫–∞
- –ö—Ä–∞—Å–∏–≤—ã–π –±–ª–æ–∫ —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –¥–æ—Å—Ç–∞–≤–∫–µ –≤ –∞–¥–º–∏–Ω–∫–µ –∑–∞–∫–∞–∑–∞
- –£–¥–æ–±–Ω–æ–µ —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –≤ –¥–≤—É—Ö –∫–æ–ª–æ–Ω–∫–∞—Ö
- –ö–Ω–æ–ø–∫–∏ "–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å" –∏ "–ü–µ—á–∞—Ç—å" –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞ —Ä–∞–±–æ—Ç—ã
- JavaScript —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏

## –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
–§–∞–π–ª –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –æ—Å–Ω–æ–≤–Ω—ã–º –ø–ª–∞–≥–∏–Ω–æ–º —á–µ—Ä–µ–∑ —Ö—É–∫ `plugins_loaded`:

```php
add_action('plugins_loaded', array($this, 'load_delivery_data_handler'));
```

### –ü—Ä–æ–≥—Ä–∞–º–º–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ
–î–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –¥–æ—Å—Ç–∞–≤–∫–∏ –∏–∑ –¥—Ä—É–≥–æ–≥–æ –∫–æ–¥–∞:

```php
// –°–æ–∑–¥–∞–Ω–∏–µ —ç–∫–∑–µ–º–ø–ª—è—Ä–∞ –∫–ª–∞—Å—Å–∞
$handler = new CDEK_Delivery_Data_Handler();

// –ü–æ–ª—É—á–µ–Ω–∏–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –¥–æ—Å—Ç–∞–≤–∫–µ
$delivery_info = $handler->get_formatted_delivery_info($order_id);

// –†–µ–∑—É–ª—å—Ç–∞—Ç:
// array(
//     'display_name' => '–¢—é–º–µ–Ω—å, –ê–≤—Ç–æ—Ä–µ–º–æ–Ω—Ç–Ω–∞—è',
//     'cost' => '2190 —Ä—É–±.',
//     'address' => '625017, –†–æ—Å—Å–∏—è, –¢—é–º–µ–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å, –¢—é–º–µ–Ω—å, –ê–≤—Ç–æ—Ä–µ–º–æ–Ω—Ç–Ω–∞—è, 47',
//     'code' => 'TYU123',
//     'phone' => '+7 (xxx) xxx-xx-xx',
//     'work_time' => '–ü–Ω-–ü—Ç: 9:00-18:00',
//     'city' => '–¢—é–º–µ–Ω—å'
// )
```

## –•—É–∫–∏ WordPress

–ö–ª–∞—Å—Å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å–ª–µ–¥—É—é—â–∏–µ —Ö—É–∫–∏:

### –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
```php
add_action('woocommerce_email_order_details', array($this, 'add_delivery_info_to_email'), 20, 4);
add_action('woocommerce_checkout_order_processed', array($this, 'save_delivery_data_to_order'), 10, 3);
add_action('woocommerce_checkout_update_order_meta', array($this, 'save_delivery_meta_data'), 10, 1);
add_action('woocommerce_admin_order_data_after_shipping_address', array($this, 'display_delivery_info_in_admin'), 15);
add_action('woocommerce_order_status_changed', array($this, 'log_delivery_data_change'), 10, 3);
```

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã
- Email —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è: –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç 20 (–ø–æ—Å–ª–µ –æ—Å–Ω–æ–≤–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –∑–∞–∫–∞–∑–µ)
- –ê–¥–º–∏–Ω–∫–∞: –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç 15 (–ø–æ—Å–ª–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö –ø–æ–ª–µ–π –∞–¥—Ä–µ—Å–∞ –¥–æ—Å—Ç–∞–≤–∫–∏)

## –®–∞–±–ª–æ–Ω—ã

### HTML Email —à–∞–±–ª–æ–Ω
```html
<div style="background: #f8f9fa; border: 1px solid #28a745; padding: 20px; margin: 20px 0; border-radius: 8px;">
    <h3 style="color: #28a745;">üì¶ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –¥–æ—Å—Ç–∞–≤–∫–µ –°–î–≠–ö</h3>
    <p><strong>–ü—É–Ω–∫—Ç –≤—ã–¥–∞—á–∏:</strong> –¢—é–º–µ–Ω—å, –ê–≤—Ç–æ—Ä–µ–º–æ–Ω—Ç–Ω–∞—è</p>
    <p><strong>–°—Ç–æ–∏–º–æ—Å—Ç—å –¥–æ—Å—Ç–∞–≤–∫–∏:</strong> <span style="color: #28a745;">2190 —Ä—É–±.</span></p>
    <p><strong>–ê–¥—Ä–µ—Å:</strong> 625017, –†–æ—Å—Å–∏—è, –¢—é–º–µ–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å, –¢—é–º–µ–Ω—å, –ê–≤—Ç–æ—Ä–µ–º–æ–Ω—Ç–Ω–∞—è, 47</p>
    <!-- ... –æ—Å—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è ... -->
</div>
```

### –¢–µ–∫—Å—Ç–æ–≤—ã–π Email —à–∞–±–ª–æ–Ω
```
==================================================
–ò–ù–§–û–†–ú–ê–¶–ò–Ø –û –î–û–°–¢–ê–í–ö–ï –°–î–≠–ö
==================================================
–ü—É–Ω–∫—Ç –≤—ã–¥–∞—á–∏: –¢—é–º–µ–Ω—å, –ê–≤—Ç–æ—Ä–µ–º–æ–Ω—Ç–Ω–∞—è
–°—Ç–æ–∏–º–æ—Å—Ç—å –¥–æ—Å—Ç–∞–≤–∫–∏: 2190 —Ä—É–±.
–ê–¥—Ä–µ—Å: 625017, –†–æ—Å—Å–∏—è, –¢—é–º–µ–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å, –¢—é–º–µ–Ω—å, –ê–≤—Ç–æ—Ä–µ–º–æ–Ω—Ç–Ω–∞—è, 47
–ö–æ–¥ –ø—É–Ω–∫—Ç–∞: TYU123
==================================================
```

## –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

–ö–ª–∞—Å—Å –≤–µ–¥–µ—Ç –ø–æ–¥—Ä–æ–±–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π:

```php
error_log('–°–î–≠–ö Data Handler: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∞ —Å—Ç–æ–∏–º–æ—Å—Ç—å –¥–æ—Å—Ç–∞–≤–∫–∏ –¥–ª—è –∑–∞–∫–∞–∑–∞ ' . $order_id . ': ' . $delivery_cost . ' —Ä—É–±.');
error_log('–°–î–≠–ö Data Handler: –°–æ—Ö—Ä–∞–Ω–µ–Ω –∫–æ–¥ –ø—É–Ω–∫—Ç–∞ –≤—ã–¥–∞—á–∏ –¥–ª—è –∑–∞–∫–∞–∑–∞ ' . $order_id . ': ' . $point_code);
error_log('–°–î–≠–ö Data Handler: –°–æ—Ö—Ä–∞–Ω–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ –ø—É–Ω–∫—Ç–∞ –≤—ã–¥–∞—á–∏ –¥–ª—è –∑–∞–∫–∞–∑–∞ ' . $order_id . ': ' . $point_name);
```

## –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è

- WordPress 5.0+
- WooCommerce 8.0+
- PHP 7.4+

## –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å

- ‚úÖ –ù–æ–≤—ã–µ –±–ª–æ–∫–∏ WooCommerce (Block-based checkout)
- ‚úÖ –ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞
- ‚úÖ –í—Å–µ —Ç–µ–º—ã WooCommerce
- ‚úÖ –ú–æ–±–∏–ª—å–Ω—ã–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
- ‚úÖ Email –∫–ª–∏–µ–Ω—Ç—ã (Gmail, Outlook, Apple Mail –∏ –¥—Ä.)

## –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

- –í—Å–µ –¥–∞–Ω–Ω—ã–µ –ø—Ä–æ—Ö–æ–¥—è—Ç —á–µ—Ä–µ–∑ `sanitize_text_field()`
- HTML –≤—ã–≤–æ–¥ —ç–∫—Ä–∞–Ω–∏—Ä—É–µ—Ç—Å—è —á–µ—Ä–µ–∑ `esc_html()` –∏ `esc_attr()`
- –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–µ—Ä–µ–¥ –æ–±—Ä–∞–±–æ—Ç–∫–æ–π
- –í–∞–ª–∏–¥–∞—Ü–∏—è JSON –¥–∞–Ω–Ω—ã—Ö

## –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

- –ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
- –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –∫–ª–∞—Å—Å–∞
- –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ SQL –∑–∞–ø—Ä–æ—Å—ã —á–µ—Ä–µ–∑ WooCommerce API
- –õ–µ–Ω–∏–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ (–∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏)

## –û—Ç–ª–∞–¥–∫–∞

–î–ª—è –≤–∫–ª—é—á–µ–Ω–∏—è –æ—Ç–ª–∞–¥–∫–∏ –¥–æ–±–∞–≤—å—Ç–µ –≤ `wp-config.php`:

```php
define('WP_DEBUG', true);
define('WP_DEBUG_LOG', true);
```

–õ–æ–≥–∏ –±—É–¥—É—Ç –∑–∞–ø–∏—Å—ã–≤–∞—Ç—å—Å—è –≤ `/wp-content/debug.log`

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–∞

```
cdek-delivery-data-handler.php
‚îú‚îÄ‚îÄ Class CDEK_Delivery_Data_Handler
‚îÇ   ‚îú‚îÄ‚îÄ __construct()                      # –ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –∫–ª–∞—Å—Å–∞
‚îÇ   ‚îú‚îÄ‚îÄ init_hooks()                       # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ö—É–∫–æ–≤
‚îÇ   ‚îú‚îÄ‚îÄ add_delivery_info_to_email()       # –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ email
‚îÇ   ‚îú‚îÄ‚îÄ save_delivery_data_to_order()      # –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–∏ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–∏
‚îÇ   ‚îú‚îÄ‚îÄ save_delivery_meta_data()          # –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö
‚îÇ   ‚îú‚îÄ‚îÄ save_structured_delivery_data()    # –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
‚îÇ   ‚îú‚îÄ‚îÄ display_delivery_info_in_admin()   # –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ –∞–¥–º–∏–Ω–∫–µ
‚îÇ   ‚îú‚îÄ‚îÄ get_delivery_data_from_order()     # –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
‚îÇ   ‚îú‚îÄ‚îÄ render_html_email_template()       # HTML —à–∞–±–ª–æ–Ω
‚îÇ   ‚îú‚îÄ‚îÄ render_text_email_template()       # –¢–µ–∫—Å—Ç–æ–≤—ã–π —à–∞–±–ª–æ–Ω
‚îÇ   ‚îú‚îÄ‚îÄ render_admin_template()            # –®–∞–±–ª–æ–Ω –∞–¥–º–∏–Ω–∫–∏
‚îÇ   ‚îú‚îÄ‚îÄ log_delivery_data_change()         # –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π
‚îÇ   ‚îî‚îÄ‚îÄ get_formatted_delivery_info()      # –ü—É–±–ª–∏—á–Ω—ã–π API
‚îî‚îÄ‚îÄ new CDEK_Delivery_Data_Handler()       # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
```

## –ê–≤—Ç–æ—Ä

–†–∞–∑—Ä–∞–±–æ—Ç–∞–Ω–æ –¥–ª—è –ø–ª–∞–≥–∏–Ω–∞ –°–î–≠–ö –î–æ—Å—Ç–∞–≤–∫–∞ –¥–ª—è WooCommerce v1.0.0