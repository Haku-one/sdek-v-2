# СДЭК Доставка для WooCommerce

Плагин для интеграции доставки СДЭК с поддержкой как блочного, так и классического чекаута WooCommerce.

## Возможности

- ✅ Поддержка классического чекаута WooCommerce
- ✅ Поддержка блочного чекаута WooCommerce  
- ✅ Интерактивная карта пунктов выдачи
- ✅ Умный поиск городов с автодополнением
- ✅ Автоматический расчет стоимости доставки
- ✅ Валидация выбора пункта выдачи
- ✅ Адаптивный дизайн для мобильных устройств
- ✅ Шорткод для ручного размещения карты

## Установка

1. Загрузите файлы плагина в папку `/wp-content/plugins/cdek-delivery/`
2. Активируйте плагин в админ-панели WordPress
3. Настройте учетные данные СДЭК в разделе "Настройки → СДЭК Доставка"

## Использование

### Автоматическое размещение

Плагин автоматически определяет тип чекаута и размещает карту в подходящем месте:

- **Классический чекаут**: карта появляется после выбора метода доставки СДЭК
- **Блочный чекаут**: карта интегрируется в блоки чекаута

### Ручное размещение (шорткод)

Для ручного размещения карты используйте шорткод:

```
[cdek_delivery_map]
```

**Параметры шорткода:**
- `height` - высота карты (по умолчанию 450px)
- `show_always` - показывать карту всегда (true/false, по умолчанию false)

**Примеры:**
```
[cdek_delivery_map height="300px"]
[cdek_delivery_map show_always="true"]
```

## Настройка

### Основные настройки

1. Перейдите в "Настройки → СДЭК Доставка"
2. Введите учетные данные СДЭК:
   - Account (Аккаунт)
   - Password (Пароль)
3. Укажите API ключ Яндекс.Карт
4. Выберите город отправителя

### Настройка метода доставки

1. Перейдите в "WooCommerce → Настройки → Доставка"
2. Добавьте зону доставки для России
3. Добавьте метод доставки "СДЭК"
4. Настройте параметры метода доставки

## Как это работает

### Для покупателя

1. На странице чекаута выбирает метод доставки СДЭК
2. Появляется карта с поиском городов
3. Вводит название города в поле поиска
4. Выбирает пункт выдачи на карте или в списке
5. Автоматически рассчитывается стоимость доставки
6. Оформляет заказ

### Для администратора

1. В деталях заказа отображается выбранный пункт выдачи
2. Информация о пункте выдачи включается в email уведомления
3. Доступна история выбора пунктов выдачи

## Технические особенности

### Совместимость

- WordPress 5.0+
- WooCommerce 8.0+
- PHP 7.4+
- Поддержка классического и блочного чекаута

### Адаптация под темы

Плагин автоматически адаптируется под большинство тем WordPress. Если карта отображается некорректно, используйте шорткод для ручного размещения.

### Производительность

- Оптимизирован для мобильных устройств
- Ленивая загрузка карт
- Кеширование результатов поиска
- Минимальное воздействие на производительность сайта

## Устранение неполадок

### Карта не отображается

1. Проверьте API ключ Яндекс.Карт
2. Убедитесь, что выбран метод доставки СДЭК
3. Попробуйте использовать шорткод для ручного размещения

### Ошибки расчета стоимости

1. Проверьте учетные данные СДЭК
2. Убедитесь, что указаны габариты товаров
3. Проверьте настройки города отправителя

### Конфликты с темой

1. Используйте шорткод `[cdek_delivery_map]` для ручного размещения
2. Добавьте кастомные CSS стили при необходимости

## API и хуки для разработчиков

### Хуки действий

```php
// Добавление карты в классический чекаут
add_action('woocommerce_review_order_after_shipping', 'custom_cdek_map');

// Альтернативная позиция
add_action('woocommerce_checkout_after_customer_details', 'custom_cdek_map');
```

### Фильтры

```php
// Кастомизация полей адреса
add_filter('woocommerce_checkout_fields', 'custom_checkout_fields');

// Отключение стандартных полей города/индекса
add_filter('woocommerce_shipping_calculator_enable_city', '__return_false');
add_filter('woocommerce_shipping_calculator_enable_postcode', '__return_false');
```

### JavaScript события

```javascript
// Событие выбора пункта выдачи
$(document).on('cdek_point_selected', function(event, pointData) {
    console.log('Выбран пункт:', pointData);
});

// Событие расчета стоимости
$(document).on('cdek_cost_calculated', function(event, cost) {
    console.log('Стоимость доставки:', cost);
});
```

## Поддержка

При возникновении проблем:

1. Проверьте логи WordPress (WP_DEBUG = true)
2. Убедитесь в актуальности версий WordPress и WooCommerce
3. Деактивируйте другие плагины для проверки конфликтов

## Лицензия

GPL v2 или выше

## Changelog

### 1.0.0
- Первый релиз
- Поддержка классического и блочного чекаута
- Интеграция с API СДЭК
- Интерактивная карта пунктов выдачи
- Умный поиск городов